include:
  - path:
      - docker-compose.yml

x-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  alloy-gateway:
    mem_limit: 300m
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      # intenta wget o curl dentro del contenedor; falla si ninguno existe
      test: ["CMD-SHELL", "if command -v wget >/dev/null 2>&1; then wget -qO- http://localhost:4318/health || exit 1; elif command -v curl >/dev/null 2>&1; then curl -fsS http://localhost:4318/health || exit 1; else echo 'no curl/wget'; exit 1; fi"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  loki:
    mem_limit: 700m
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "if command -v wget >/dev/null 2>&1; then wget -qO- http://localhost:3100/ready || exit 1; elif command -v curl >/dev/null 2>&1; then curl -fsS http://localhost:3100/ready || exit 1; else echo 'no curl/wget'; exit 1; fi"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  tempo:
    mem_limit: 600m
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "if command -v wget >/dev/null 2>&1; then wget -qO- http://localhost:3200/ready || exit 1; elif command -v curl >/dev/null 2>&1; then curl -fsS http://localhost:3200/ready || exit 1; else echo 'no curl/wget'; exit 1; fi"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  mimir:
    mem_limit: 1g
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "if command -v wget >/dev/null 2>&1; then wget -qO- http://localhost:9009/ready || exit 1; elif command -v curl >/dev/null 2>&1; then curl -fsS http://localhost:9009/ready || exit 1; else echo 'no curl/wget'; exit 1; fi"]
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 10s

  grafana:
    mem_limit: 500m
    restart: unless-stopped
    environment:
      GF_SECURITY_ALLOW_EMBEDDING: "false"
      GF_AUTH_DISABLE_LOGIN_FORM: "false"
      GF_LOG_LEVEL: "warn"
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "if command -v wget >/dev/null 2>&1; then wget -qO- http://localhost:3000/api/health || exit 1; elif command -v curl >/dev/null 2>&1; then curl -fsS http://localhost:3000/api/health || exit 1; else echo 'no curl/wget'; exit 1; fi"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  node-exporter:
    mem_limit: 120m
    restart: unless-stopped
    logging: *default-logging

  cadvisor:
    mem_limit: 350m
    restart: unless-stopped
    logging: *default-logging
