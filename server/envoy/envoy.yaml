admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:
  listeners:
    # OTLP gRPC Listener (puerto 4317)
    - name: otlp_grpc_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 4317
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: otlp_grpc
                codec_type: AUTO
                access_log:
                  - name: envoy.access_loggers.stdout
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                route_config:
                  name: otlp_routes
                  virtual_hosts:
                    - name: observability_backends
                      domains: ["*"]
                      routes:
                        # Traces OTLP gRPC
                        - match:
                            prefix: "/opentelemetry.proto.collector.trace"
                          route:
                            cluster: tempo_grpc
                            timeout: 30s
                        # Metrics OTLP gRPC
                        - match:
                            prefix: "/opentelemetry.proto.collector.metrics"
                          route:
                            cluster: mimir_otlp_grpc
                            timeout: 30s
                        # Logs OTLP gRPC
                        - match:
                            prefix: "/opentelemetry.proto.collector.logs"
                          route:
                            cluster: loki_otlp_grpc
                            timeout: 30s
                        # Fallback
                        - match:
                            prefix: "/"
                          route:
                            cluster: tempo_grpc
                http_filters:
                  # 1. JWT Authentication (validación con Keycloak)
                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        keycloak_provider:
                          issuer: http://keycloak:8080/realms/observability
                          remote_jwks:
                            http_uri:
                              uri: http://keycloak:8080/realms/observability/protocol/openid-connect/certs
                              cluster: keycloak
                              timeout: 5s
                            cache_duration: 300s
                          forward: true
                          payload_in_metadata: jwt_payload
                      rules:
                        - match:
                            prefix: "/"
                          requires:
                            requires_any:
                              requirements:
                                - provider_name: keycloak_provider
                                - allow_missing: {} # Permite requests sin JWT (para API keys)

                  # 2. Lua Filter (extrae headers y agrega X-Scope-OrgID)
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function envoy_on_request(request_handle)
                          local path = request_handle:headers():get(":path") or ""
                          local country = request_handle:headers():get("x-country") or "pe"
                          local environment = request_handle:headers():get("x-environment") or "prod"
                          local system = request_handle:headers():get("x-system") or "default"

                          -- Normalizar a minúsculas
                          country = string.lower(country)
                          environment = string.lower(environment)
                          system = string.lower(system)

                          -- Determinar X-Scope-OrgID según tipo de señal
                          local scope_orgid

                          if string.find(path, "trace") then
                            -- Traces: Por sistema-ambiente (ej: ecommerce-prod)
                            scope_orgid = system .. "-" .. environment
                          elseif string.find(path, "metrics") then
                            -- Metrics: Por ambiente (ej: talma-prod)
                            scope_orgid = "talma-" .. environment
                          elseif string.find(path, "logs") then
                            -- Logs: Por país (ej: talma-pe)
                            scope_orgid = "talma-" .. country
                          else
                            -- Fallback para traces
                            scope_orgid = system .. "-" .. environment
                          end

                          -- Agregar header X-Scope-OrgID
                          request_handle:headers():add("x-scope-orgid", scope_orgid)

                          -- Log para debugging
                          request_handle:logInfo(string.format(
                            "Routing: path=%s, country=%s, env=%s, system=%s, scope=%s",
                            path, country, environment, system, scope_orgid
                          ))
                        end

                  # 3. Router
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    # OTLP HTTP Listener (puerto 4318)
    - name: otlp_http_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 4318
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: otlp_http
                codec_type: AUTO
                access_log:
                  - name: envoy.access_loggers.stdout
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                route_config:
                  name: otlp_http_routes
                  virtual_hosts:
                    - name: observability_backends
                      domains: ["*"]
                      routes:
                        # Traces OTLP HTTP
                        - match:
                            prefix: "/v1/traces"
                          route:
                            cluster: tempo_http
                            timeout: 30s
                        # Metrics OTLP HTTP → Mimir via OTLP
                        - match:
                            prefix: "/v1/metrics"
                          route:
                            cluster: mimir_otlp_http
                            timeout: 30s
                        # Logs OTLP HTTP → Loki
                        - match:
                            prefix: "/v1/logs"
                          route:
                            cluster: loki_http
                            timeout: 30s
                        # Prometheus Remote Write → Mimir
                        - match:
                            prefix: "/api/v1/push"
                          route:
                            cluster: mimir_http
                        # Loki Push API
                        - match:
                            prefix: "/loki/api/v1/push"
                          route:
                            cluster: loki_http
                http_filters:
                  # 1. JWT Authentication
                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        keycloak_provider:
                          issuer: http://keycloak:8080/realms/observability
                          remote_jwks:
                            http_uri:
                              uri: http://keycloak:8080/realms/observability/protocol/openid-connect/certs
                              cluster: keycloak
                              timeout: 5s
                            cache_duration: 300s
                          forward: true
                          payload_in_metadata: jwt_payload
                      rules:
                        - match:
                            prefix: "/"
                          requires:
                            requires_any:
                              requirements:
                                - provider_name: keycloak_provider
                                - allow_missing: {}

                  # 2. Lua Filter (mismo código que gRPC)
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function envoy_on_request(request_handle)
                          local path = request_handle:headers():get(":path") or ""
                          local country = request_handle:headers():get("x-country") or "pe"
                          local environment = request_handle:headers():get("x-environment") or "prod"
                          local system = request_handle:headers():get("x-system") or "default"

                          country = string.lower(country)
                          environment = string.lower(environment)
                          system = string.lower(system)

                          local scope_orgid

                          if string.find(path, "trace") then
                            scope_orgid = system .. "-" .. environment
                          elseif string.find(path, "metrics") or string.find(path, "api/v1/push") then
                            scope_orgid = "talma-" .. environment
                          elseif string.find(path, "logs") or string.find(path, "loki") then
                            scope_orgid = "talma-" .. country
                          else
                            scope_orgid = system .. "-" .. environment
                          end

                          request_handle:headers():add("x-scope-orgid", scope_orgid)

                          request_handle:logInfo(string.format(
                            "Routing: path=%s, country=%s, env=%s, system=%s, scope=%s",
                            path, country, environment, system, scope_orgid
                          ))
                        end

                  # 3. Router
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # Keycloak - Para validación JWT
    - name: keycloak
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: keycloak
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: keycloak
                      port_value: 8080

    # Tempo - Traces (gRPC + HTTP)
    - name: tempo_grpc
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      http2_protocol_options: {}
      load_assignment:
        cluster_name: tempo_grpc
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: tempo
                      port_value: 4317

    - name: tempo_http
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: tempo_http
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: tempo
                      port_value: 4318

    # Mimir - Metrics (OTLP gRPC, OTLP HTTP, Prometheus Remote Write)
    - name: mimir_otlp_grpc
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      http2_protocol_options: {}
      load_assignment:
        cluster_name: mimir_otlp_grpc
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: mimir
                      port_value: 4317

    - name: mimir_otlp_http
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: mimir_otlp_http
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: mimir
                      port_value: 4318

    - name: mimir_http
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: mimir_http
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: mimir
                      port_value: 9009

    # Loki - Logs (OTLP gRPC, HTTP Push API)
    - name: loki_otlp_grpc
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      http2_protocol_options: {}
      load_assignment:
        cluster_name: loki_otlp_grpc
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: loki
                      port_value: 4317

    - name: loki_http
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: loki_http
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: loki
                      port_value: 3100
